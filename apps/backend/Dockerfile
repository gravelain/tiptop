# üõ† √âtape 1 : Construction de l'application
FROM node:20-alpine AS build

# D√©finir le r√©pertoire de travail
WORKDIR /app

# Copier uniquement les fichiers n√©cessaires pour l'installation des d√©pendances
COPY package*.json ./

# Installer les d√©pendances (inclut devDeps car on est encore en build)
RUN npm ci

# Copier le reste du code source
COPY . .

# Compiler le projet NestJS
RUN npm run build


# üßº √âtape 2 : Image finale optimis√©e pour la production
FROM node:20-alpine

# D√©finir le r√©pertoire de travail
WORKDIR /app

# Copier les fichiers construits depuis l'√©tape de build
COPY --from=build /app/dist ./dist

# Copier package.json et package-lock.json pour r√©installer les deps
COPY --from=build /app/package*.json ./

# Installer uniquement les d√©pendances de production
RUN npm ci --omit=dev

# Exposer le port (modifie-le si ton app Nest utilise un port diff√©rent)
EXPOSE 5000

# Commande de d√©marrage (via script dans package.json)
CMD ["npm", "run", "start:prod"]
